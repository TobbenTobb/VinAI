version: "3.1"

intents:
  - saludar
  - despedirse
  - recomendar_vino
  - informar_gusto
  - buscar_tour_vina
  - recomendar_tour
  - informar_ano
  - registrar_usuario
  - iniciar_sesion
  - guardar_preferencia_vino
  - valorar_tour
  - pedir_ayuda
  - informar_rating
  - informar_comentario

entities:
  - cepa
  - tipo_vino
  - valle
  - vina
  - sabor_nota
  - caracteristica
  - maridaje
  - ano
  - email
  - password
  - rating_number

slots:
  slot_cepa:
    type: text
    influence_conversation: true
    mappings: 
    - type: from_entity
      entity: cepa
      
  slot_tipo_vino:
    type: text
    influence_conversation: true
    mappings: 
    - type: from_entity
      entity: tipo_vino

  slot_valle:
    type: text
    influence_conversation: true
    mappings: 
    - type: from_entity
      entity: valle
      
  slot_vina:
    type: text
    influence_conversation: true
    mappings: 
    - type: from_entity
      entity: vina
  
  slot_caracteristica:
    type: text
    influence_conversation: true
    mappings: 
    - type: from_entity
      entity: caracteristica
      
  slot_maridaje:
    type: text
    influence_conversation: true
    mappings: 
    - type: from_entity
      entity: maridaje

  slot_ano:
    type: text
    influence_conversation: true
    mappings:
    - type: from_entity
      entity: ano

  slot_email:
    type: text
    influence_conversation: false
    mappings:
    - type: from_entity
      entity: email
  slot_password:
    type: text
    influence_conversation: false
    mappings:
    - type: from_entity
      entity: password
      
  slot_user_id:
    type: text
    influence_conversation: true
    mappings: [] 
    
  slot_vina_a_valorar: 
    type: text
    influence_conversation: false
    mappings:
    - type: from_text
      conditions:
      - active_loop: valorar_tour_form
        requested_slot: slot_vina_a_valorar

  slot_rating:
    type: categorical
    values: ["1", "2", "3", "4", "5"] 
    influence_conversation: false
    mappings:
    - type: from_entity
      entity: rating_number
  
# === INICIO DE LA CORRECCIÓN ===
  slot_comentario:
    type: text
    influence_conversation: false
    mappings:
    # 1. Acepta un comentario normal (ej: "fue genial")
    - type: from_intent
      intent: informar_comentario
      value: "placeholder" # El valor no importa, actions.py usará el texto
      
    # 2. Acepta explícitamente la intención 'deny' (ej: "no")
    - type: from_intent
      intent: deny
      value: "no" # Le pasamos el texto "no" a la action

    # 3. Acepta cualquier otro texto que no sea un 'deny'
    - type: from_text
      intent:
      - not: deny
      conditions:
      - active_loop: valorar_tour_form
        requested_slot: slot_comentario
  # === FIN DE LA CORRECCIÓN ===

# === SECCIÓN 'FORMS' QUE FALTABA ===
forms:
  valorar_tour_form:
    required_slots:
      - slot_vina_a_valorar
      - slot_rating
      - slot_comentario

actions:
  - action_recomendar_vino_db
  - action_buscar_tour
  - action_recomendar_tour_db
  - utter_saludar
  - utter_despedirse
  - utter_pedir_gusto
  - action_registrar_usuario
  - action_iniciar_sesion
  - action_guardar_preferencia
  - validate_valorar_tour_form # Esta es la acción correcta para el formulario
  - utter_ayuda
  - utter_pedir_email
  - utter_pedir_password
  - utter_ya_estas_logueado
  - utter_registro_exitoso
  - utter_login_exitoso
  - utter_login_fallido
  - utter_preferencia_guardada
  - utter_ask_slot_vina_a_valorar
  - utter_ask_slot_rating
  - utter_ask_slot_comentario
  - utter_valoracion_guardada
  
responses:
  utter_saludar:
    - text: "¡Hola! Soy VinAI, tu sommelier virtual. Puedes pedirme una recomendación de vino, buscar un tour o 'iniciar sesión' para usar tus preferencias guardadas."
  
  utter_despedirse:
    - text: "¡Adiós! Que tengas un excelente día y salud."
    
  utter_pedir_gusto:
    - text: "¡Claro! Para recomendarte el vino perfecto, ¿podrías decirme qué tipo de vino prefieres (tinto, blanco, etc.), alguna cepa o con qué comida lo vas a maridar?"

  utter_pedir_email:
    - text: "Perfecto, ¿cuál es tu email?"
  utter_pedir_password:
    - text: "Gracias, ¿cuál es tu contraseña?"
  utter_ya_estas_logueado:
    - text: "¡Ya has iniciado sesión!"
  utter_registro_exitoso:
    - text: "¡Genial! Tu cuenta ha sido creada. Ya puedes iniciar sesión."
  utter_login_exitoso:
    - text: "¡Bienvenido de nuevo! He iniciado sesión con tu cuenta."
  utter_login_fallido:
    - text: "Lo siento, no pude verificar tus credenciales. ¿El email y contraseña son correctos?"
  utter_preferencia_guardada:
    - text: "¡Entendido! He guardado esa preferencia en tu perfil."

  # === CORRECCIÓN DE INDENTACIÓN ===
  utter_ayuda:
    - text: "¡Claro! Soy VinAI, tu asistente de vinos y enoturismo. Puedo ayudarte con esto:<br><br>* **Recomendar Vinos:** Pídeme un vino por cepa, año, maridaje o características (ej. 'recomiéndame un tinto para carnes').<br>* **Buscar Tours:** Pregúntame por tours en una viña específica (ej. '¿qué tours hay en Santa Rita?').<br>* **Recomendar Tours:** Pídeme que te recomiende un tour por valle (ej. 'recomiéndame un tour en Colchagua').<br>* **Crear tu Perfil:** Escribe 'iniciar sesión' o 'registrarme' para guardar tus gustos.<br>* **Guardar Gustos:** Si iniciaste sesión, puedes decirme 'guarda que me gusta el Carmenere'.<br>* **Valorar Tours:** Si iniciaste sesión, puedes decir 'quiero valorar Montes con 5 estrellas'."

  # --- Responses del Formulario ---
  utter_ask_slot_vina_a_valorar:
    - text: "¿Qué viña te gustaría valorar?"
  utter_ask_slot_rating:
    - text: "¡Perfecto! ¿Qué puntaje del 1 al 5 le das a {slot_vina_a_valorar}?"
  utter_ask_slot_comentario:
    - text: "Gracias. ¿Te gustaría añadir un comentario? (o puedes decir 'no')"
  utter_valoracion_guardada:
    - text: "¡Listo! He guardado tu valoración para {slot_vina_a_valorar}. ¡Gracias por tu feedback!"